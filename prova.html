<!DOCTYPE html>
<html>
<head>
    <title>Concept Map with jsMind</title>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/jsmind@0.8.7/style/jsmind.css" />
    <script type="text/javascript" src="https://unpkg.com/jsmind@0.8.7/es6/jsmind.js"></script>
    <script type="text/javascript" src="https://unpkg.com/jsmind@0.8.7/es6/jsmind.draggable-node.js"></script>
    <style>
        #jsmind_container {
            width: 70%;
            height: 600px;
            border: 1px solid #ccc;
            float: left;
        }
        #controls {
            width: 28%;
            float: right;
            padding: 10px;
            box-sizing: border-box;
        }
        /* These styles apply to the content generated by node_html_generator */
        .jmnode-title-display {
            font-weight: bold;
            padding: 5px;
        }
        .jmnode-content-display {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
            padding: 0 5px 5px 5px;
            white-space: pre-wrap; /* Respect newlines in content */
            word-wrap: break-word;
        }
        .form-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            background: #f8f8f8;
        }
        #jsonOutput {
            clear: both;
            padding: 20px;
            margin-top: 20px;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .selected-node {
            background: #e3f2fd;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #2196F3;
            word-wrap: break-word; /* Ensure long text wraps */
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div id="jsmind_container"></div>
    <div id="controls">
        <h3>Controls</h3>

        <div class="form-group">
            <button onclick="addNode()">‚ûï Add Node</button>
            <button onclick="removeNode()">‚ûñ Remove Node</button>
            <input type="file" id="jsonFile" accept=".json,.jsmind" style="display:none;">
            <button onclick="document.getElementById('jsonFile').click()">üìÅ Import JSON</button>
            <button onclick="exportJSON()">üíæ Export JSON</button>
        </div>

        <div class="form-group">
            <h4>Selected Parent Node:</h4>
            <div id="selected_parent" class="selected-node">
                Select a node...
            </div>
        </div>

        <div class="form-group">
            <h4>Create New Node:</h4>
            <label for="new_node_title">Title:</label>
            <input type="text" id="new_node_title" placeholder="Enter title" required>

            <label for="new_node_content">Content:</label>
            <textarea id="new_node_content" placeholder="Enter content" rows="3"></textarea>
        </div>
    </div>

    <div id="jsonOutput">
        <h3>JSON Output (for debugging/sharing)</h3>
        <pre id="json_display"></pre>
    </div>

    <script>
        let jm = null;
        let selectedParent = null; // This will store the actual jsMind node object

        const mind = {
            meta: {name: 'Concept Map', author: 'User', version: '1.0'},
            format: 'node_tree',
            data: { // This is the root node definition
                id: 'root',
                topic: 'Central Concept',
                data: {content: 'This is the main idea of the concept map.'}, // Node-specific data
                expanded: true,
                children: []
            }
        };

        function init() {
            const options = {
                container: 'jsmind_container',
                editable: true,
                theme: 'primary',
                mode: 'full',
                view: {
                    engine: 'canvas',
                    hmargin: 100,
                    vmargin: 50,
                    line_width: 2,
                    line_color: '#555',
                    node_html_generator: function(node) {
                        // Safeguard: node.data might be undefined if not set. Default to {}.
                        const nodeData = node.data || {};
                        const titleHtml = `<div class="jmnode-title-display">${jsMind.util.text.encode_html(node.topic)}</div>`;
                        let contentHtml = '';
                        // Only add content div if content actually exists and is not empty
                        console.log(nodeData)
                        if (nodeData.content && String(nodeData.content).trim() !== '') {
                            contentHtml = `<div class="jmnode-content-display">${jsMind.util.text.encode_html(nodeData.content)}</div>`;
                        }
                        return titleHtml + contentHtml;
                    }
                },
                shortcut:{
                    enable: true,
                    mapping:{
                        addchild : 45 // FIX: Replaced jsMind.key.insert with its keycode value 45
                    }
                }
            };

            jm = new jsMind(options);
            jm.show(mind);

            // Set initial selected parent to root and update display
            selectedParent = jm.get_node('root');
            if (selectedParent) {
                updateSelectedParentDisplay(selectedParent);
            }

            jm.add_event_listener(function(type, eventPayload) {
                if(type === jsMind.event_type.select_node) { // Use constant for event type
                    selectedParent = eventPayload.node; // eventPayload.node is the selected jsMind node object
                    updateSelectedParentDisplay(selectedParent);
                    updateJSON();
                }
            });

            document.getElementById('jsonFile').addEventListener('change', handleFileUpload);
            updateJSON(); // Initial JSON display
        }

        function updateSelectedParentDisplay(node) {
            if (!node) {
                document.getElementById('selected_parent').innerHTML = 'No node selected.';
                return;
            }
            const nodeData = node.data || {};
            const contentText = (nodeData.content && String(nodeData.content).trim() !== '') ? `<br><em>${jsMind.util.text.encode_html(nodeData.content)}</em>` : '';
            document.getElementById('selected_parent').innerHTML =
                `${jsMind.util.text.encode_html(node.topic)}${contentText}`;
        }


        function addNode() {
            if (!selectedParent) {
                alert('Please select a parent node first.');
                return;
            }

            const title = document.getElementById('new_node_title').value.trim();
            const content = document.getElementById('new_node_content').value.trim();

            if(!title) {
                alert('Please enter a title for the new node.');
                return;
            }

            const nodeId = `node-${Date.now()}-${Math.random().toString(16).slice(2)}`; // More unique ID

            // The 'data' here is the custom payload for the node
            const nodeDataPayload = {};
            if (content) { // Only add content to data if it's not empty
                nodeDataPayload.content = content;
            }

            jm.add_node(selectedParent, nodeId, title, nodeDataPayload);

            document.getElementById('new_node_title').value = '';
            document.getElementById('new_node_content').value = '';

            updateJSON();
        }

        function removeNode() {
            if(!selectedParent) {
                alert('Please select a node to remove.');
                return;
            }
            if(selectedParent.isroot) { // jsMind nodes have an 'isroot' boolean property
                alert('Cannot delete the root node.');
                return;
            }

            const parentOfRemoved = selectedParent.parent;
            jm.remove_node(selectedParent.id); // remove_node takes id or node object

            // Select the parent of the removed node, or root if the parent was also removed (shouldn't happen here)
            selectedParent = parentOfRemoved || jm.get_node('root');
            if (selectedParent) {
                jm.select_node(selectedParent.id); // Reselect to trigger UI updates
                updateSelectedParentDisplay(selectedParent);
            } else {
                 updateSelectedParentDisplay(null); // In case root was somehow removed
            }
            updateJSON();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileContent = JSON.parse(e.target.result);
                    let mindDataToLoad;

                    // Check if the imported file is in jsMind's own format or our custom export format
                    if (fileContent.format === 'node_tree' && fileContent.data) { // jsMind native-like structure
                        mindDataToLoad = fileContent;
                    } else if (fileContent.format === 'custom_concept_map' && fileContent.data) { // Our custom export
                         mindDataToLoad = {
                            meta: fileContent.meta || mind.meta,
                            format: 'node_tree',
                            data: convertToJsMindFormat(fileContent.data) // Convert our root node structure
                        };
                    } else if (fileContent.id && fileContent.topic) { // Assuming it's just a root node_tree data object
                         mindDataToLoad = {
                            meta: mind.meta,
                            format: 'node_tree',
                            data: fileContent // The entire file is the root node_tree data
                        };
                    }
                    else {
                        alert('Invalid JSON format. Expected jsMind node_tree or custom concept map format.');
                        return;
                    }

                    jm.show(mindDataToLoad);
                    selectedParent = jm.get_node('root'); // Reselect root after loading
                    if (selectedParent) {
                        jm.select_node(selectedParent.id);
                        updateSelectedParentDisplay(selectedParent);
                    }
                    updateJSON();
                } catch(error) {
                    alert(`Error processing JSON file: ${error.message}`);
                    console.error("JSON Import Error:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Reset file input to allow re-uploading the same file
        }

        // Converts a node from your custom export format TO jsMind's internal node_tree format expectation
        function convertToJsMindFormat(customNode) {
            const jsMindNodeData = {};
            if (customNode.content) {
                jsMindNodeData.content = customNode.content;
            }
            return {
                id: customNode.id,
                topic: customNode.title, // Your export has 'title', jsMind uses 'topic'
                data: jsMindNodeData,     // Custom payload
                expanded: customNode.expanded === undefined ? true : customNode.expanded, // Default to expanded
                children: customNode.children?.map(convertToJsMindFormat) || []
            };
        }

        function exportJSON() {
            const currentMindData = jm.get_data('node_tree'); // {meta, format, data: rootNodeObject}
            if (!currentMindData || !currentMindData.data) {
                alert("No data to export.");
                return;
            }

            // Transform jsMind's internal data to your desired export format
            const dataToExport = {
                meta: currentMindData.meta,
                format: 'custom_concept_map', // Your custom format identifier
                data: transformFromJsMindFormat(currentMindData.data) // Transform the root node
            };

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${(currentMindData.meta.name || 'concept-map').replace(/\s+/g, '_')}-${Date.now()}.json`;
            document.body.appendChild(a); // Necessary for Firefox
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            updateJSON(); // Update the display with what was exported
        }

        // Transforms a node FROM jsMind's internal format (as returned by get_data) TO your custom export format
        function transformFromJsMindFormat(jsMindNode) {
            const nodeData = jsMindNode.data || {}; // Safeguard
            const customNode = {
                id: jsMindNode.id,
                title: jsMindNode.topic, // jsMind uses 'topic', your export uses 'title'
                expanded: jsMindNode.expanded,
            };
            // Only include content if it exists and is not empty
            if (nodeData.content && String(nodeData.content).trim() !== '') {
                customNode.content = nodeData.content;
            }
            if (jsMindNode.children && jsMindNode.children.length > 0) {
                customNode.children = jsMindNode.children.map(transformFromJsMindFormat);
            }
            return customNode;
        }

        function updateJSON() {
            if (!jm || !jm.mind) {
                document.getElementById('json_display').textContent = "Mind map not initialized or no data.";
                return;
            }
            const currentMindData = jm.get_data('node_tree');
             if (!currentMindData || !currentMindData.data) {
                document.getElementById('json_display').textContent = "No data available in the mind map.";
                return;
            }
            // Display the data in your custom export format
            const displayData = {
                meta: currentMindData.meta,
                format: 'custom_concept_map_preview',
                data: transformFromJsMindFormat(currentMindData.data)
            };
            document.getElementById('json_display').textContent =
                JSON.stringify(displayData, null, 2);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>